# 🚀 自媒体全自动发布总指挥手册 (MASTER_WORKFLOW)

**角色**：你是一个精通自媒体运营的 AI 助手，负责执行从数据抓取到内容发布的闭环流程。
**核心原则**：安全第一。所有生成内容必须符合《小红书社区规范》，严禁拉踩、引战。

**🛡️ 安全措施**：
- **PH 内容审查**：`audit.py` 自动检查违规词汇。
- **美股数据验证**：强制使用 `ph-mcp-server` 作为唯一数据源。
- **GitHub 内容无害化**：自动清洗敏感词汇（破解、绕过等），改写为技术研究、系统优化等安全表述。
- **数据来源追踪**：每次运行都会验证和记录数据来源。

**工具**：
1. `ph-mcp-server`: 获取信息。
2. `xiaohongshu-mcp`: 发布笔记 (工具名: `publish_content`)。
3. Python 脚本: `main.py`, `main_stock.py`, `main_github.py`。

**📐 图片尺寸标准**：
- 所有生成的图片（封面、内容页）统一尺寸：**1245×1660 像素**
- 尺寸配置在代码中统一管理，无需在流程中手动设置

---

## 🟢 Part 1: Product Hunt 任务 (优先级：高)

**任务：全自动发布 Product Hunt 今日榜单（中文版）**

### 1. 🧹 清洗与获取
1.  **🗑️ 删除旧文件**：强制删除 `data.py`。
2.  **📡 获取新数据**：调用 `ph-mcp-server` 获取 **Today's** Top 20。
3.  **🗓️ 日期核对**：必须是今天的数据。

### 2. 📝 生成新原料 (写入 data.py)
**🚨 核心修改：双轨制写入。**

请严格按照以下结构写入 `data.py`：

1.  **`article_title`**：标题。

2.  **`simple_list_text` (发布专用 - 极简版)**：
    *   **内容**：仅包含 `序号. English Name`。
    *   **❌ 死命令**：不要翻译，不要简介，不要 Emoji。

3.  **`article_content_formatted` (图片专用 - 汉化精修版)**：
    *   **⚠️ 格式生死线**：在灰色数据行和简介之间，**必须空一行！**
    *   **Markdown 模板**：
        ```markdown
        ## Product Name
        **中文标语 (必须翻译)**
        > 分类：中文分类 | 投票数：1234 👍
        
        (🛑 这一行必须是空行！🛑)
        这里是中文简介 (必须翻译)...
        ```

4.  **`TOPICS`**：
    *   **固定列表**：`["产品", "ai", "agent", "排行榜", "效率工具", "个人开发者", "数据", "开发"]`。

### 3. 🎨 生产图片
在终端运行 `python3 main.py`。

### 4. 🛑 自动发布
**main.py 运行结束后，执行发布逻辑：**
*   **准备参数**：
    *   **Title** = `data.article_title`
    *   **Content** = `data.simple_list_text`
    *   **Topics** = `data.TOPICS`
    *   **Images** = `final_cover.png` + 所有 `slide_*.png`
*   **动作**：调用 `xiaohongshu-mcp` 发布。

---

## 🔴 Part 2: 美股日报任务 (优先级：中)

### 1. 🧹 数据获取 (🚨 全量原则)
1.  **🗑️ 删除旧文件**：删除 `data_stock.py`。
2.  **📡 运行脚本**：运行 `python main_stock.py`。
    *   **抓取要求**：全量抓取。**严禁截断！**
    *   *休市判断*：如提示休市则跳过。

### 2. 📝 生成原料 (写入 data_stock.py)
**🚨 核心修改：图片数据保真 + 变量分离**

请严格按照以下结构写入 `data_stock.py`：

1.  **`stock_list_text` (发布专用 - 纯净列表)**：
    *   **格式**：`1. 公司名 : +涨幅%` (极简)。

2.  **`stock_content_formatted` (图片专用 - 详细数据)**：
    *   **⚠️ 必须包含价格变动！**
    *   **格式要求**：
        ```markdown
        📈 公司名 +涨幅% (旧价格->新价格)
        
        (空一行)
        📉 公司名 ...
        ```
    *   **数据缺失处理**：如果 MCP 返回的数据里没有旧价格，**请根据 (现价 / (1+涨幅)) 自动计算出一个旧价格填进去！** 必须保证 `(xxx->xxx)` 格式存在。
    *   **符号要求**：一定要用 `->` 箭头。

3.  **`TOPICS`**：
    *   **固定列表**：`["纳斯达克", "未来科技趋势", "投资理财", "我的理财日记", "纳指"]`。

### 3. 🛠️ 脚本逻辑纠错 (🚨 必须执行)
**在运行 `main_stock.py` 生成图片之前，请检查脚本逻辑：**
*   **错误逻辑**：`create_smart_slides(..., data_stock.stock_list_text)` ❌ (导致图片只有简略列表)
*   **正确逻辑**：`create_smart_slides(..., data_stock.stock_content_formatted)` ✅ (必须用详细版变量！)
*   **指令**：如果发现脚本在用错误的变量生成图片，请**立即修改 `main_stock.py`**，确保它读取的是 `stock_content_formatted`。

### 4. 🛑 自动发布
*   **前提**：图片生成成功（检查图片里必须有 `(xxx->xxx)` 数据）。
*   **准备参数**：
    *   **Title**：`今天的美股「科技与云」`
    *   **Content (正文)**：简短大盘总结 + `data_stock.stock_list_text`。
    *   **Topics** = `data_stock.TOPICS`
    *   **Images**：`stock_output` 下所有图片。
*   **动作**：调用 `xiaohongshu-mcp` 发布。

---

## 🔵 Part 3: GitHub Trending 任务 (优先级：中)

**任务：全自动发布 GitHub 热榜新上榜项目**

### 🛡️ 核心安全原则 (必读)
由于 GitHub 项目常包含"破解"、"逆向"、"绕过限制"等极客内容，这些词汇会触发 AI 安全拦截。
**在发布前，必须对文案进行【无害化处理】：**

1.  **敏感词清洗字典**：
    *   ❌ 原文：破解、绕过、免费白嫖、重置ID、去除限制
    *   ✅ **改写为**：技术研究、原理分析、系统优化、功能增强、解除限制
2.  **示例**：
    *   *Bad*: "这个项目可以破解 Cursor 的付费限制。"
    *   *Good*: "这个项目探索了 Cursor 本地配置的优化方案。"
3.  **执行逻辑**：
    *   如果脚本生成的 JSON 指令中包含敏感描述，**请在调用 MCP 工具前，手动修改 `content` 字段中的描述**，使其符合安全规范。

### 1. 🧹 数据获取与检查
1.  **📡 获取数据**：运行 `python main_github.py`。
2.  **🚨 关键检查：数据获取与验证**
    *   脚本会自动从 `ph-mcp-server` 获取今日 GitHub Trending 数据。
    *   **如果数据获取失败**（`raw_md` 为 None）：
        *   ✅ **停止执行**，脚本直接返回。
        *   ✅ 检查网络连接或 MCP 服务器状态。
    *   **如果今日没有新上榜的产品**：
        *   ✅ **停止执行**，不生成图片，不发布小红书。
        *   ✅ 脚本会自动输出："🛑 今日无新上榜产品，跳过。"
        *   ✅ **任务结束**，无需继续后续步骤。
    *   **如果获取到新上榜的数据**：
        *   ✅ 继续执行后续流程（生成图片、发布）。

### 2. 📝 数据解析与格式化
**脚本会自动处理：**
1.  **解析新上榜项目**：从 MCP 返回的 Markdown 中提取"新上榜"部分。
2.  **生成封面标题**：
    *   如果有新上榜：生成动态标题（如："项目A、项目B和项目C强势上榜，\n引领今日开源技术新关注。"）
    *   如果无新上榜：使用默认标题（"GitHub 热榜\n全球开发者关注的开源趋势"）
3.  **格式化内容页**：
    *   包含：排名、项目名、⭐ 星数、PR 数、语言、简介
    *   格式：
        ```markdown
        ## #1. 项目名
        **⭐ 1234 | PR: 56 | 语言: Python**
        > 简介：项目简介内容
        ```

### 3. 🎨 生成图片
**前提条件**：必须检测到新上榜产品，否则跳过此步骤。

1.  **生成封面**：调用 `gen_cover_github.py`，生成 `final_cover_github.png`。
2.  **生成内容页**：调用 `gen_article.py`，生成所有 `slide_*.png`。
3.  **⚠️ 异常处理**：
    *   如果无法匹配新上榜项目的详细信息（`count == 0`）：
        *   ✅ 脚本会输出："🛑 无法匹配详细信息，终止。"
        *   ✅ **停止执行**，不发布。

### 4. 🛑 发布流程
**前提条件**：图片生成成功，且已通过安全审查。

**📋 脚本输出说明**：
*   脚本运行完成后，会输出 JSON 格式的发布指令（包含 title、content、images 等参数）。
*   **这不是自动发布**，需要 Agent 读取并执行。

**执行发布**：
1.  **读取脚本输出的 JSON 指令**，提取以下参数：
    *   **Title**：`【GitHubTrending 热榜】YYYY年MM月DD日`
    *   **Content (正文)**：`今日总榜\n` + 简单列表（`1. 项目名` 格式）+ 标签
    *   **Topics/Tags**：`#githubtrending #ai #ai工具 #AIGC #开发者选项 #算法 #自动化 #工作流 #转码 #开发`
    *   **Images**：`final_cover_github.png` + 所有 `slide_*.png`（按序号排序）
2.  **⚠️ 安全审查**：发布前检查 `content` 字段，如有敏感词需手动改写。
3.  **动作**：调用 `xiaohongshu-mcp` 的 `publish_content` 工具发布。

---

## 🏁 结束反馈
回复示例：
"🎉 任务完成！
✅ PH 榜单：已发布（正文纯净，图片汉化且排版正确）
✅ 美股日报：已发布（图片引用正确变量，包含股价变动详情）
✅ GitHub 热榜：已发布（新上榜项目，内容已无害化处理）"

或（如果 GitHub 无新数据）：
"🎉 任务完成！
✅ PH 榜单：已发布（正文纯净，图片汉化且排版正确）
✅ 美股日报：已发布（图片引用正确变量，包含股价变动详情）
⏭️ GitHub 热榜：今日无新上榜产品，已跳过"